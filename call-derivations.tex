% !TEX root = main.tex
\subsection{Function calls derivations}

\subsubsection{Context nesting}
We say that \emph{$\ctx\vdash s$ creates $\ctx'\vdash(B',G')| B$} when

$$
\begin{array}{ll}
&\left\{
    \begin{array}{lll}
    s.\code &=&  \call{x_\Addr,x_\Str,x_1,\dots,x_n, x_\Nat};B \\
    \ctx' &=&(\callDataVal\mapsto c,
     \thisVal\mapsto a,
     \senderVal\mapsto\ctx.\thisVal)
    \end{array}\right.\\
\hbox{ or }&\\
&\left\{
    \begin{array}{lll}
    s.\code &=& \dcall{x_\Addr,x_\Str,x_1,\dots,x_n, x_\Nat};B \\
    \ctx'&=&\ctx\set{\callDataVal\mapsto c},
    \end{array}
    \right.
\end{array}
$$
$$
\begin{array}{cc}
\hbox{and }
\left\{
    \begin{array}{lll}
    s.\memory(x_\Addr) & = & a \\
    s.\memory(x_\Str) & = & f \\
    s.\memory(x_i) & = & c[i]\quad \forall i\leq n \\
    s.\memory(x_\Nat) & = & G' \\
    \bytecode{}' &=& s.\state(a).\Abi(f)\\
    s.\gas &\geq& G' + \dcl
    \end{array}\right.
\end{array}
$$

for some $x_\Addr$,\dots,$x_\Nat$, $c$,$a$, and $f$. This definition applies to all (context,step) pairs that create a new call frame, whether through a call or a delegatecall. 

$\ctx'$ is the call context. For a call, it changes the values of $\thisVal$ and $\senderVal$. For a delegatecall, it keeps those of $\ctx$. 

$B'$ is the bytecode of the new call frame and corresponds to the code at the given function ($f$) name at the given address ($a$). 

$G'$ is the gas given for the call. 

$B$ is the continuation bytecode after the call has ended (i.e. the rest of the bytecode after $s$'s call instruction).

\subsubsection{Derivation of a function call}

\begin{table}[ht]
$$
\begin{array}{c}
\dfrac{
    \begin{array}{lll}
    % s.\code &=& I;B\\
    \multicolumn{3}{l}{\textrm{$\ctx\vdash s$ creates $\ctx'\vdash (B',G')|B$}}\\
     \mathsf{\ctx'}&\vdash& 
     (\bytecode{}{}',G,[],\zMem,s.\state) \to^* t \nrightarrow\\
     \state &:=& \left\{
    \begin{array}{l}
        \textrm{$t.\state$ if $t$ returns $r$}\\
        \textrm{$s.\state$ if $t$ reverts $r$}
    \end{array}\right.\\
    \textit{gas} &:=& s.\textit{gas}-\dcl+t.\textit{gas}-G'
    \end{array}
}{
 \ctx
 \vdash
 s
 \rar 
 (\bytecode,\textit{gas},r,s.\textit{mem},
 \state
 )
}\rlab{xcall}
\end{array}
$$
\end{table}

