% !TEX root = main.tex
\subsection{Function calls derivations}

\paragraph{Call step.}
A $\step$ \emph{calls $(a\in\Addr,B\in\bytecodes,c\in\vec{\vals},G\in\Nat)$ with continuation} $B'$ when
$$
\step.\code = \mathsf{(d)}\call{x_\Addr,x_\Str,x_1,\dots,x_n, x_\Nat};B'
$$
and
$$
\begin{array}{lll}
a&=&\step.\memory(x_\Addr) \\
B&=&\step.\state(a).\Abi(\step.\memory(x_\Str)) \\
c[i]&=&\step.\memory(x_i) \\
G&=&\step.\memory(x_\Nat)
\end{array}
$$
We say that the above call step \emph{delegates} if the opcode is ${\sf dcall}$.

\paragraph{Derivation of a function call}

$$
\dfrac{
	\begin{array}{l}
	\textrm{$\step$ calls $(a,B,c,G)$ with continuation $B'$} \\
	\ctx' = \left\{\begin{array}{l}
	\ctx\set{\callDataVal\mapsto c} \textrm{ if $\step$ delegates}\\
	(\callDataVal\mapsto c,\thisVal\mapsto a,\senderVal\mapsto\ctx.\thisVal) \textrm{ otherwise}\\
	\end{array}\right. \\
	\ctx'\vdash (B,G,[],\zMem,\step.\state)\to^* \step' \nrightarrow \\
	G' = \step.\gas-\dcl+(\step'.\gas-G) \\
	\state' =\left\{
    \begin{array}{l}
        \textrm{$\step'.\state$ if $\step'$ returns $r$}\\
        \textrm{$\step.\state$ if $\step$ reverts $r$}
    \end{array}\right.
	\end{array}
}
{\ctx\vdash\step \rar \ctx\vdash (B',G' ,r,\step.\memory,\state')}\rlab{(d)call}
$$

